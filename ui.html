<style>
  /* ===== common ===== */
  body {
    margin: 0;
  }

  input[type=text]:read-only {
    border: none;
    pointer-events: none;
  }

  button {
    cursor: pointer;
    border: none;
    background: none;
  }

  /* ===== header ===== */

  .header {
    position: fixed;
    top: 0;
    left: 0;
    display: flex;
    width: 100%;
    background: #2C2C2C;
  }

  .header-button {
    display: flex;
    align-items: center;
    padding: 6px;
  }
    .header-button:hover {
      background: #000000;
    }
    .header-button svg {
      width: 18px;
      height: 18px;
    }

  /* ===== list ===== */

  .figmark-list {
    margin: auto;
    padding: 30px 0 0;
  }

  .figmark-list li {
    display: flex;
    align-items: center;
    padding: 2px 0 2px;
    background-color: #FFFFFF;
  }
    .figmark-list li:hover {
      outline: 1px solid #00A1FF;
      outline-offset: -1px;
    }

  .figmark-list li div {
    overflow: hidden;
    flex-grow: 1;
    height: 1rem;
    padding: 6px 0 6px 10px;
    font-size: 11px;
    cursor: default;
  }

  .figmark-list li button {
    display: none;
    width: 30px;
    height: 28px;
    padding: 0;
    border-radius: 3px;
  }
    .figmark-list li:hover > button {
      display: inline-block;
    }
    .figmark-list li button svg {
      width: 18px;
      height: 18px;
      fill: #232323;
    }
</style>

<header class="header">
  <button id="add-button" class="header-button" onclick="onPostMessage('add-bookmark')">
    <svg width="32" height="31" viewBox="0 0 32 31" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M1.15076 15.5H30.8492" stroke="white"/>
      <path d="M16 30.3492L16 0.650759" stroke="white"/>
    </svg>
  </button>
</header>
<ul id="figmark-list" class="figmark-list"></ul>

<script>

/* ===== post message ===== */

const onPostMessage = (type, value) => {
  parent.postMessage({ pluginMessage: { type, value } }, "*")
}

/* ===== create bookmarak list ===== */

const MAX_TEXT_LENGTH = 30

const listWrapper = document.getElementById("figmark-list")

// elements
const e_div = document.createElement("div")
const e_li = document.createElement("li")
e_li.setAttribute("draggable", "true")
const e_button = document.createElement("button")
e_button.innerHTML = `
    <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="#000000"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M16 9v10H8V9h8m-1.5-6h-5l-1 1H5v2h14V4h-3.5l-1-1zM18 7H6v12c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7z"/></svg>
  `

onmessage = (event) => {
  const data = event.data.pluginMessage

  if(data.type === "update-figmark") {
    listWrapper.innerHTML = ""
    data.value.forEach(v => {
      const li = e_li.cloneNode(true)
      li.id = v.id

      const div = e_div.cloneNode(true)
      div.innerText = v.name

      let textCount = 0
      div.addEventListener("click", (e) => {
        onPostMessage("select-node", {id: v.id, page: v.page})
      })
      div.addEventListener("dblclick", (e) => {
        // change the name
        textCount = div.innerText.length
        div.contentEditable = true
        div.focus()
      })
      div.addEventListener("focus", () => {
        document.execCommand('selectAll', false, null)
      })
      div.addEventListener("blur", (e) => {
        // update bookmark
        div.contentEditable = false
        textCount = e.target.innerText.length
        onPostMessage("update-bookmark", {id: v.id, name: e.target.innerText})
      })
      div.addEventListener("keyup", (e) => {
        if(e.key === "Enter" && div.innerText.indexOf('\n') !== -1) {
          // no line breaks
          div.innerText = div.innerText.replaceAll('\n', '')
          div.blur()
          return
        }
        textCount = e.target.innerText.length
        if(e.key === "Enter" || e.key === "Backspace") return
        if(e.target.innerText.length == MAX_TEXT_LENGTH) {
          div.blur()
        }
      })
      li.appendChild(div)

      const deleteButton = e_button.cloneNode(true)
      deleteButton.onclick = (() => {
        onPostMessage("delete-bookmark", {id: v.id})
      })
      li.appendChild(deleteButton)

      listWrapper.appendChild(li)
    });

    let dragId = ""
    document.querySelectorAll('.figmark-list li').forEach (elm => {
      elm.ondragstart = function () {
        dragId = elm.id
      };
      elm.ondragover = function (event) {
        event.preventDefault();
        let rect = this.getBoundingClientRect();
        if ((event.clientY - rect.top) < (this.clientHeight / 2)) {
          //マウスカーソルの位置が要素の半分より上
          this.style.borderTop = '2px solid black';
          this.style.borderBottom = '';
        } else {
          //マウスカーソルの位置が要素の半分より下
          this.style.borderTop = '';
          this.style.borderBottom = '2px solid black';
        }
      };
      elm.ondragleave = function () {
        this.style.borderTop = '';
        this.style.borderBottom = '';
      };
      elm.ondrop = function (event) {
        event.preventDefault();
        let elm_drag = document.getElementById(dragId);

        let rect = this.getBoundingClientRect();
        if ((event.clientY - rect.top) < (this.clientHeight / 2)) {
          //マウスカーソルの位置が要素の半分より上
          this.parentNode.insertBefore(elm_drag, this);
        } else {
          //マウスカーソルの位置が要素の半分より下
          this.parentNode.insertBefore(elm_drag, this.nextSibling);
        }
        this.style.borderTop = '';
        this.style.borderBottom = '';
        dragId = '';
      };
    });
  }
}

</script>
