<style>
  input[type=text]:read-only {
    border: none;
    pointer-events: none;
  }
</style>

<button id="add">+mark</button>
<ul id="figmark-list"></ul>

<script>

// ブックマークの追加
document.getElementById("add").onclick = () => {
  parent.postMessage({ pluginMessage: { type: "add-bookmark" } }, "*")
}

// ブックマークしたコンポーネントを選択
const findNode = (id, page) => {
  parent.postMessage({ pluginMessage: { type: "select-node", id: id, page: page } }, "*")
}

// ブックマークから削除
const deleteMark = (id) => {
  parent.postMessage({ pluginMessage: { type: "delete-bookmark", id: id } }, "*")
}

// ブックマーク情報の更新
const updateMark = (id, value) => {
  parent.postMessage({ pluginMessage: { type: "update-bookmark", id: id, value: value} }, "*")
}


/* =====================================
  ここからDOMとイベントの生成
===================================== */

onmessage = (event) => {
  const data = event.data.pluginMessage
  if(data.type === "update-figmark") {
    const listWrapper = document.getElementById("figmark-list")
    listWrapper.innerHTML = ""
    data.value.forEach(v => {
      // TODO: 複数選択してたら全部追加できるようにする
      // TODO: 選択したものにフォーカスをあてる
      // TODO: スタイルをあてる

      const input = document.createElement("input")
      input.readOnly = true
      input.type = "text"
      input.value = v.name
      input.addEventListener("blur", (e) => {
        input.readOnly = true
        updateMark(v.id, e.target.value)
      })

      const li = document.createElement("li")
      li.id = `item_${v.id}`
      li.dataset.id = v.id
      li.dataset.page = v.page
      li.appendChild(input)

      // selectボタン
      const button = document.createElement("button")
      const selectButton = button.cloneNode(true)
      selectButton.innerText = "select"
      selectButton.onclick = (() => findNode(v.id, v.page))
      li.appendChild(selectButton)

      // deleteボタン
      const deleteButton = button.cloneNode(true)
      deleteButton.innerText = "delete"
      deleteButton.onclick = (() => deleteMark(v.id))
      li.appendChild(deleteButton)

      // editボタン
      const editButton = button.cloneNode(true)
      editButton.innerText = "edit"
      editButton.onclick = (() => {
        const item = document.getElementById(`item_${v.id}`)
        const input = item.querySelector("input")
        input.readOnly = false
        input.focus()
      })
      li.appendChild(editButton)

      listWrapper.appendChild(li)
    });
  }
}

</script>
